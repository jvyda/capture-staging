version: 1
backend:
  phases:
    build:
      commands:
        - npm ci --cache .npm --prefer-offline
        - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
frontend:
  phases:
    build:
      commands:
        - npm run build
        - export NEXT_PUBLIC_AWS_REGION=$NEXT_PUBLIC_AWS_REGION
        - export NEXT_PUBLIC_AWS_ACCESS_KEY_ID=$NEXT_PUBLIC_AWS_ACCESS_KEY_ID
        - export NEXT_PUBLIC_AWS_SECRET_ACCESS_KEY=$NEXT_PUBLIC_AWS_SECRET_ACCESS_KEY
        - export NEXT_PUBLIC_VIDEOS_CDN_DOMAIN=$NEXT_PUBLIC_VIDEOS_CDN_DOMAIN
        - export NEXT_PUBLIC_PHOTOS_CDN_DOMAIN=$NEXT_PUBLIC_PHOTOS_CDN_DOMAIN
        - export NEXT_PUBLIC_FRAMES_CDN_DOMAIN=$NEXT_PUBLIC_FRAMES_CDN_DOMAIN
        - export NEXT_PUBLIC_FACE_DETECTION_THUMBNAILS_CDN_DOMAIN=$NEXT_PUBLIC_FACE_DETECTION_THUMBNAILS_CDN_DOMAIN
        - export NEXT_PUBLIC_S3_PHOTOS_BUCKET_NAME=$NEXT_PUBLIC_S3_PHOTOS_BUCKET_NAME
        - export NEXT_PUBLIC_S3_FRAMES_BUCKET_NAME=$NEXT_PUBLIC_S3_FRAMES_BUCKET_NAME
        - export NEXT_PUBLIC_APPSYNC_API_ENDPOINT=$NEXT_PUBLIC_APPSYNC_API_ENDPOINT
        - export NEXT_PUBLIC_APPSYNC_API_KEY=$NEXT_PUBLIC_APPSYNC_API_KEY
        - export NEXT_PUBLIC_SQS_FACE_DETECTION_QUEUE_URL=$NEXT_PUBLIC_SQS_FACE_DETECTION_QUEUE_URL
        - export NEXT_PUBLIC_DYNAMODB_PHOTOS_TABLE_NAME=$NEXT_PUBLIC_DYNAMODB_PHOTOS_TABLE_NAME
        - export NEXT_PUBLIC_DYNAMODB_FRAMES_TABLE_NAME=$NEXT_PUBLIC_DYNAMODB_FRAMES_TABLE_NAME
        - export NEXT_PUBLIC_DYNAMODB_FACES_TABLE_NAME=$NEXT_PUBLIC_DYNAMODB_FACES_TABLE_NAME
        - export NEXT_PUBLIC_DYNAMODB_PERSONS_TABLE_NAME=$NEXT_PUBLIC_DYNAMODB_PERSONS_TABLE_NAME
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - .next/cache/**/*
      - .npm/**/*
      - node_modules/**/*